name: PHPStan

on:
  workflow_call:
    inputs:
      phpVersion:
        description: "The PHP version to use. Defaults to 'latest'."
        type: string
        required: false
        default: "latest"
      phpstanVersion:
        description: "The PHPStan version to use. Defaults to the latest available version."
        type: string
        required: false
        default: ""

jobs:
  phpstan:
    name: "PHPStan"
    runs-on: "ubuntu-latest"

    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          persist-credentials: false

      - name: Check for existence of a PHPStan config file
        id: has_config
        uses: andstor/file-existence-action@076e0072799f4942c8bc574a82233e1e4d13e9d6 # v3.0.0
        with:
          files: "phpstan.neon*"

      - name: Create tools string
        id: tools
        run: |
          if [ "${{ inputs.phpstanVersion }}" == "" ]; then
            echo 'TOOLS=phpstan' >> "$GITHUB_OUTPUT"
          else
            echo 'TOOLS=phpstan:${{ inputs.phpstanVersion }}' >> "$GITHUB_OUTPUT"
          fi

      - name: Install PHP
        if: ${{ steps.has_config.outputs.files_exists == 'true' }}
        uses: shivammathur/setup-php@bf6b4fbd49ca58e4608c9c89fba0b8d90bd2a39f # 2.35.5
        with:
          php-version: ${{ inputs.phpVersion }}
          coverage: none
          tools: ${{ steps.tools.outputs.TOOLS }}

      # Install dependencies and handle caching in one go.
      # Dependencies need to be installed to make sure the PHPUnit classes are recognized.
      # @link https://github.com/marketplace/actions/install-php-dependencies-with-composer
      - name: Install Composer dependencies
        if: ${{ steps.has_config.outputs.files_exists == 'true' }}
        uses: "ramsey/composer-install@3cf229dc2919194e9e36783941438d17239e8520" # 3.1.1
        with:
          # Bust the cache at least once a month - output format: YYYY-MM.
          custom-cache-suffix: $(date -u "+%Y-%m")

      - name: Run PHPStan
        if: ${{ steps.has_config.outputs.files_exists == 'true' }}
        run: phpstan analyse
